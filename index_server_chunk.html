<html>
<head>
<script type="text/javascript" src="static/scripts/jquery.js"></script>
<script type="text/javascript" src='static/scripts/spark-md5.min.js'></script>
<script type="text/javascript">
	$(function() {
		$("#submit_form_button").click(function() {
			var files = $("#image_upload").prop('files'); // Not a simple array, a FileList 
			upload_files(files);
		});

		// Checks the number of bytes uploaded of the passed files 
		// Adds a property to each file object called 'uploaded_bytes'
		function get_upload_amounts(files) {
			file_keys = []; // Key of the file using which a file will be checked 
			$(files).each(function(index, file) {
				file_keys.push(get_file_key(file))
			});

			var file_uploaded = {}

			// Check upload amount 
			data = JSON.stringify(file_keys)
			$.ajax({
				url : 'check_upload',
				type : 'POST',
				contentType : "application/json",
				processData : false,
				data : data,
				async : false,
				success : function(data) {
					file_uploaded = JSON.parse(data);
				},
				error : function(data) {
					alert("Checking Upload: Something went wrong");
				}
			});
			return file_uploaded;
		}

		// returns the file key of a file 
		// MD5 hash of file contents. Optimized approach as file is loaded into memory in chunks 
		function get_file_key(file) {
			var chunkSize = 1024 * 1024 * 20; // 20 MB chunks 
			var chunks = Math.ceil(file.size / chunkSize);
			var currentChunk = 0;
			var spark = new SparkMD5.ArrayBuffer();
			var hash = ""; // Default, enables fresh upload of file. 
			frOnload = function(e) {
	            console.log("Read chunk #", currentChunk + 1, "of", chunks);
	            spark.append(e.target.result); 
	            currentChunk++;

	            if (currentChunk < chunks)
	            	loadNextSlice();
	            else
	            	hash = spark.end(); // Computed HASH 
	        };
	        frOnerror = function () {
	            console.warn("File Reader: Something went wrong.");
	            throw "Couldn't fetch the key. Uploading file from begining"
	        };
	        function loadNextSlice() {
	            var fileReader = new FileReader();
	            fileReader.onload = frOnload;
	            fileReader.onerror = frOnerror;

	            var start = currentChunk * chunkSize,
	                end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;

	            fileReader.readAsArrayBuffer(file.slice(start, end));
	        };
	        loadNextSlice();
	        return hash;
		}

		function upload_files(files) {
			form_data = get_form_data(files)
			headers = get_headers(files[0]); // TODO: Only one file is allowed because get_headers is written like that 
			$.ajax({
				cache : false,
				contentType : false,
				processData : false,
				url : 'upload',
				headers : headers,
				data : form_data,
				type : 'post',
				success : function(data) {
					$("#server_resp").fadeOut(500).html(data).fadeIn(300);
				},
				error : function(data) {
					alert('File Upload: Something went wrong')
				}
			});
		}
		
		function get_form_data(files) {
			var data = new FormData();
			var imageType = /image.*/; // Only images are allowed 
			file_uploaded = get_upload_amounts(files); // Get the uplaoded amount of each file 
			$(files).each(function(i, file) {
				/* if (!file.type.match(imageType))
					continue; */
				start = file_uploaded[file.name] > 0 ? file_uploaded[file.name] - 1 : 0; // Subtracted 1 as slice's indexing is zero based
				data.append('myFile', file.slice(start)); // TODO: as of now only 1 file can  be uplaoded at once because of this line 
			});
			return data;
		}
		
		function get_headers(file) {
			file_properties=['name', 'size', 'type', 'lastModifiedDate'];
			headers = {}
			// Properties of file 
			for(property in file)
				if(file_properties.indexOf(property) >= 0)
					headers[property] = file[property];
			// General properties 
			headers['Cache-Control'] = "no-cache";
			return headers;
		}
	});
</script>
</head>
<body>
	<form method='post' action="upload" enctype="multipart/form-data"
		id="upload_image_form">
		<input type="hidden" id="file_chunk" /> <input type="file"
			id="image_upload" name="myFile" /> <br /> <input type="button"
			id="submit_form_button" value="upload" />
	</form>
	<div id="server_resp" style="display: none;"></div>
</body>
</html>